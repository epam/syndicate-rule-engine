## Lambda `custodian-metrics-updater`

This lambda is designed to collect all scans data for certain period. The reports generated by 
`caas-report-generation-handler` lambda use this data.
It will save items to `CaaSTenantMetrics` and `CaaSCustomerMetrics` DynamoDB tables and ruleset files in s3 bucket.

![custodian_metrics_pipeline.png](../../../docs/pics/custodian_metrics_pipeline.png)

### Required configuration:

#### Should have next permission actions:
- Allow: dynamodb:GetItem
- Allow: dynamodb:PutItem
- Allow: dynamodb:Scan
- Allow: dynamodb:Query
- Allow: dynamodb:BatchWriteItem
- Allow: dynamodb:ConditionCheckItem
- Allow: s3:Get*
- Allow: s3:List*
- Allow: s3:PutObject
- Allow: lambda:InvokeFunction
- Allow: ssm:GetParameter

#### DynamoDB
* CaaSSettings
* Customers
* Tenants
* CaaSTenantMetrics
* CaaSCustomerMetrics
* CaaSJobs
* CaaSBatchResults

#### S3
* `caas-rulesets-{$suffix}` - rulesets bucket;
* `caas-statistics-{$suffix}` - statistics bucket;
* `caas-metrics-{$suffix}` -  metrics bucket.

#### Settings
- `REPORT_DATE_MARKER` - dates of last metrics collection for each report level:

```json
{
 "name": "REPORT_DATE_MARKER",
 "value": {
  "last_week_date": "2023-03-07",
  "current_week_date": "2023-03-13"
 }
}
```

#### Env Variables
- `caas_rulesets_bucket` - name of s3 bucket where standards coverage are stored;
- `caas_metrics_bucket_name` - name of s3 bucket where to store collected metrics;
- `stats_s3_bucket_name` - name of s3 bucket that stores scan statistics;
- `MODULAR_AWS_REGION` - AWS region name where MODULAR has been deployed. Can be empty if it is in the same region with Custodian Service ;
- `modular_assume_role_arn` - role ARN to connect to MODULAR components if they were deployed in another AWS account;
- `application_name` - mandatory variable for `@tracer_decorator` to save lambda state to `ModulrJobs` table;
- `component_name` - mandatory variable for `@tracer_decorator` to save lambda state to `ModularJobs` table.

#### Trigger event
Cloudwatch rule `caas-metrics-updater-trigger`. The cron is set to run the lambda every Sunday at midnight.

#### Standards coverage
To calculate compliance metrics, cloud-region based compliance coverage should be stored at `caas_rulesets_bucket` bucket.

### Lambda structure:

Code logically divided into handler and 3 processors that are called one after the other sequentially: `tenant_metrics_processor`, `tenant_group_metrics_processor` and `metric_difference_processor`.

#### Tenant metrics processor
The first processor to be called, that collects all necessary information about the last week's scans - data from the 
`CaaSJobs` and `CaaSBatchResults` tables, actual tenant findings from `caas-statistics` bucket. The received data will 
be structured into a json file of the following format:

```json
{
  "customer": "EPAM Systems", 
  "tenant_name": "TENANT_NAME", 
  "from": "2023-02-07T00:00:00", 
  "to": "2023-02-14T00:00:00", 
  "last_scan_date": "2023-02-08T17:09:09.476215", 

  ```

This data has common fields for all report types (`customer`, `from`, `to`, etc.) and separate for each type: 
- overview;
- compliance;
- resource;
- rule;
- attack vector.

Resulted files will be saved to the `caas-metrics` bucket by `{$customer_name}/accounts/{$iso_date}/{$tenant_name}.json` key. 
In case of successful execution the lambda will invocate a new lambda instance to run the next step. Otherwise 
(or if tenants haven't been scanned in the last week), the next step will not be executed.

#### Tenant group metrics processor
Second step that must group tenants from previous step into tenant groups by its display name. Example: tenants with 
name field `AWS-MSTR-DEV2` and `AZURE-MSTR-DEV2` have the same display name `MSTR-DEV2`, so they need to be grouped 
together but under different cloud providers.<br>
In this processor data is compressed (the full description of resources is reduced to their number), the most vulnerable 
tenant groups are determined, the customers data for c-level reports is summarized.<br>
Resulted tenant group files will be saved to the `caas-metrics` bucket by 
`{$customer_name}/tenants/{$iso_date}/{$tenant_display_name}.json` key. 
This data has common fields for all report types (`customer`, `tenant_display_name`, `from`, `to`, etc.) and separate for each type: 
- overview;
- compliance;
- resource;
- attack vector.

Data for department and c-level reports is stored in the `CaaSTenantMetrics` and `CaaSCustomerMetrics` tables. 
A special `sort_by` field has been added, to determine the order in the top of tenants at the department level.
To determine which top an item in the table should belong to, the `type` field has been added with the following possible values:
- `RESOURCES_BY_CLOUD`
- `COMPLIANCE_BY_TENANT`
- `COMPLIANCE_BY_CLOUD`
- `RESOURCES_BY_TENANT`
- `ATTACK_BY_CLOUD`
- `ATTACK_BY_TENANT`

In case of successful execution the lambda will invocate a new lambda instance to run the next step. Otherwise, 
the next step will not be executed.

#### Metric difference processor
Last step that calculates the difference between all numeric data values for this week and previous one (if there is 
any tenant data for previous period). The sequence of actions is as follows:
- search through all customers in the `caas-metrics` bucket;
- retrieve tenant group data for the current and previous date (these dates are stored in the `REPORT_DATE_MARKER` setting);
- calculate the difference between dictionaries and overwrite the metrics for the current date.

To explore the models for each of the reports, go to this [folder](../../../docs/models).